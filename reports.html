<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports & Analytics - Farm Produce Tracker</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <header>
        <nav class="navbar">
            <div class="nav-container">
                <div class="nav-logo">
                    <i class="fas fa-seedling"></i>
                    <span>Farm Tracker</span>
                </div>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="dashboard.html" class="nav-link">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a href="crops.html" class="nav-link">Crops</a>
                    </li>
                    <li class="nav-item">
                        <a href="livestock.html" class="nav-link">Livestock</a>
                    </li>
                    <li class="nav-item">
                        <a href="sales.html" class="nav-link">Sales</a>
                    </li>
                    <li class="nav-item">
                        <a href="reports.html" class="nav-link active">Reports</a>
                    </li>
                    <li class="nav-item">
                        <a href="#" onclick="api.logout()" class="nav-link">Logout</a>
                    </li>
                </ul>
                <div class="hamburger">
                    <span class="bar"></span>
                    <span class="bar"></span>
                    <span class="bar"></span>
                </div>
            </div>
        </nav>
    </header>

    <main class="dashboard">
        <div class="container">
            <div class="dashboard-header">
                <h1><i class="fas fa-chart-bar"></i> Reports & Analytics</h1>
                <p>Comprehensive analysis of your farm's performance and profitability</p>
            </div>

            <!-- Summary Statistics -->
            <div class="dashboard-stats">
                <div class="stat-card">
                    <i class="fas fa-seedling"></i>
                    <h3 id="total-crops">0</h3>
                    <p>Total Crops</p>
                </div>
                <div class="stat-card">
                    <i class="fas fa-cow"></i>
                    <h3 id="total-livestock">0</h3>
                    <p>Total Livestock</p>
                </div>
                <div class="stat-card">
                    <i class="fas fa-chart-line"></i>
                    <h3 id="total-sales">0</h3>
                    <p>Total Sales</p>
                </div>
                <div class="stat-card">
                    <i class="fas fa-dollar-sign"></i>
                    <h3 id="total-revenue">0 NAD</h3>
                    <p>Total Revenue</p>
                </div>
            </div>

            <!-- Financial Overview -->
            <div class="table-container">
                <div class="table-header">
                    <h3>Financial Overview</h3>
                </div>
                <div style="padding: 20px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div style="background: #d4edda; padding: 20px; border-radius: 10px; text-align: center;">
                            <h4 style="color: #155724; margin-bottom: 10px;">Paid Amount</h4>
                            <p style="font-size: 1.5rem; font-weight: bold; color: #155724;" id="paid-amount">
                                0 NAD
                            </p>
                        </div>
                        <div style="background: #fff3cd; padding: 20px; border-radius: 10px; text-align: center;">
                            <h4 style="color: #856404; margin-bottom: 10px;">Pending Amount</h4>
                            <p style="font-size: 1.5rem; font-weight: bold; color: #856404;" id="pending-amount">
                                0 NAD
                            </p>
                        </div>
                        <div style="background: #cce5ff; padding: 20px; border-radius: 10px; text-align: center;">
                            <h4 style="color: #004085; margin-bottom: 10px;">Average Sale</h4>
                            <p style="font-size: 1.5rem; font-weight: bold; color: #004085;" id="average-sale">
                                0 NAD
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Crop Analysis -->
            <div class="table-container">
                <div class="table-header">
                    <h3>Crop Analysis</h3>
                </div>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Crop Type</th>
                            <th>Number of Fields</th>
                            <th>Total Area (ha)</th>
                            <th>Total Cost (NAD)</th>
                            <th>Average Cost per ha</th>
                        </tr>
                    </thead>
                    <tbody id="crop-analysis-body">
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 20px; color: #666;">
                                Loading crop analysis...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Livestock Analysis -->
            <div class="table-container">
                <div class="table-header">
                    <h3>Livestock Analysis</h3>
                </div>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Animal Type</th>
                            <th>Number of Groups</th>
                            <th>Total Quantity</th>
                            <th>Total Value (NAD)</th>
                            <th>Average Value per Animal</th>
                        </tr>
                    </thead>
                    <tbody id="livestock-analysis-body">
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 20px; color: #666;">
                                Loading livestock analysis...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Monthly Sales Trend -->
            <div class="table-container">
                <div class="table-header">
                    <h3>Monthly Sales Trend</h3>
                </div>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Month</th>
                            <th>Number of Sales</th>
                            <th>Total Amount (NAD)</th>
                            <th>Average per Sale</th>
                        </tr>
                    </thead>
                    <tbody id="monthly-sales-body">
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 20px; color: #666;">
                                Loading monthly sales trend...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Recommendations -->
            <div class="table-container">
                <div class="table-header">
                    <h3>Recommendations</h3>
                </div>
                <div style="padding: 20px;">
                    <div id="recommendations-container">
                        <p style="text-align: center; color: #666;">Loading recommendations...</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>Farm Tracker</h3>
                    <p>Empowering Namibian farmers with digital farm management solutions.</p>
                </div>
                <div class="footer-section">
                    <h4>Quick Links</h4>
                    <ul>
                        <li><a href="dashboard.html">Dashboard</a></li>
                        <li><a href="crops.html">Crops</a></li>
                        <li><a href="livestock.html">Livestock</a></li>
                        <li><a href="sales.html">Sales</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Contact</h4>
                    <p>Email: info@farmtracker.na</p>
                    <p>Phone: +264 XX XXX XXXX</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Farm Produce Tracker. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="js/api-client.js"></script>
    <script>
        let crops = [];
        let livestock = [];
        let sales = [];

        async function loadReports() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser) {
                window.location.href = 'login.html';
                return;
            }

            try {
                // Load all data
                const [cropsData, livestockData, salesData, statsData] = await Promise.all([
                    api.getCrops(currentUser.id),
                    api.getLivestock(currentUser.id),
                    api.getSales(currentUser.id),
                    api.getDashboardStats(currentUser.id)
                ]);

                crops = cropsData;
                livestock = livestockData;
                sales = salesData;

                // Update summary statistics
                updateSummaryStats(statsData);
                
                // Generate analyses
                generateCropAnalysis();
                generateLivestockAnalysis();
                generateMonthlySalesTrend();
                generateRecommendations();

            } catch (error) {
                showNotification('Failed to load reports data', 'error');
            }
        }

        function updateSummaryStats(stats) {
            document.getElementById('total-crops').textContent = stats.total_crops;
            document.getElementById('total-livestock').textContent = stats.total_livestock;
            document.getElementById('total-sales').textContent = stats.total_sales;
            document.getElementById('total-revenue').textContent = formatCurrency(stats.total_revenue);
            
            // Calculate financial breakdown
            const paidAmount = sales.filter(s => s.payment_status === 'paid').reduce((sum, s) => sum + s.total_amount, 0);
            const pendingAmount = sales.filter(s => s.payment_status === 'pending').reduce((sum, s) => sum + s.total_amount, 0);
            const averageSale = sales.length > 0 ? sales.reduce((sum, s) => sum + s.total_amount, 0) / sales.length : 0;

            document.getElementById('paid-amount').textContent = formatCurrency(paidAmount);
            document.getElementById('pending-amount').textContent = formatCurrency(pendingAmount);
            document.getElementById('average-sale').textContent = formatCurrency(averageSale);
        }

        function generateCropAnalysis() {
            const cropStats = {};
            
            crops.forEach(crop => {
                const type = crop.crop_type;
                if (!cropStats[type]) {
                    cropStats[type] = { count: 0, area: 0, cost: 0 };
                }
                cropStats[type].count++;
                cropStats[type].area += parseFloat(crop.planted_area) || 0;
                cropStats[type].cost += parseFloat(crop.planting_cost) || 0;
            });

            const tbody = document.getElementById('crop-analysis-body');
            
            if (Object.keys(cropStats).length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px; color: #666;">No crop data available for analysis.</td></tr>';
                return;
            }

            tbody.innerHTML = Object.entries(cropStats).map(([type, stats]) => `
                <tr>
                    <td>${type}</td>
                    <td>${stats.count}</td>
                    <td>${stats.area.toFixed(2)}</td>
                    <td>${formatCurrency(stats.cost)}</td>
                    <td>${stats.area > 0 ? formatCurrency(stats.cost / stats.area) : '0.00'}</td>
                </tr>
            `).join('');
        }

        function generateLivestockAnalysis() {
            const livestockStats = {};
            
            livestock.forEach(animal => {
                const type = animal.animal_type;
                if (!livestockStats[type]) {
                    livestockStats[type] = { count: 0, quantity: 0, value: 0 };
                }
                livestockStats[type].count++;
                livestockStats[type].quantity += parseInt(animal.quantity) || 0;
                livestockStats[type].value += parseFloat(animal.purchase_price) || 0;
            });

            const tbody = document.getElementById('livestock-analysis-body');
            
            if (Object.keys(livestockStats).length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px; color: #666;">No livestock data available for analysis.</td></tr>';
                return;
            }

            tbody.innerHTML = Object.entries(livestockStats).map(([type, stats]) => `
                <tr>
                    <td>${type}</td>
                    <td>${stats.count}</td>
                    <td>${stats.quantity}</td>
                    <td>${formatCurrency(stats.value)}</td>
                    <td>${stats.quantity > 0 ? formatCurrency(stats.value / stats.quantity) : '0.00'}</td>
                </tr>
            `).join('');
        }

        function generateMonthlySalesTrend() {
            const monthlySales = {};
            
            sales.forEach(sale => {
                const month = new Date(sale.sale_date).toISOString().slice(0, 7); // YYYY-MM format
                if (!monthlySales[month]) {
                    monthlySales[month] = { count: 0, amount: 0 };
                }
                monthlySales[month].count++;
                monthlySales[month].amount += sale.total_amount;
            });

            const tbody = document.getElementById('monthly-sales-body');
            
            if (Object.keys(monthlySales).length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #666;">No sales data available for trend analysis.</td></tr>';
                return;
            }

            // Sort by month
            const sortedMonths = Object.keys(monthlySales).sort();
            
            tbody.innerHTML = sortedMonths.map(month => {
                const data = monthlySales[month];
                const monthName = new Date(month + '-01').toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
                return `
                    <tr>
                        <td>${monthName}</td>
                        <td>${data.count}</td>
                        <td>${formatCurrency(data.amount)}</td>
                        <td>${data.count > 0 ? formatCurrency(data.amount / data.count) : '0.00'}</td>
                    </tr>
                `;
            }).join('');
        }

        function generateRecommendations() {
            const recommendations = [];
            
            if (crops.length > 0) {
                recommendations.push({
                    type: 'success',
                    icon: 'fas fa-lightbulb',
                    title: 'Crop Management',
                    message: `You have ${crops.length} crops in your inventory. Consider diversifying your crop types to reduce risk and maximize seasonal opportunities.`
                });
            }
            
            const pendingAmount = sales.filter(s => s.payment_status === 'pending').reduce((sum, s) => sum + s.total_amount, 0);
            if (pendingAmount > 0) {
                recommendations.push({
                    type: 'warning',
                    icon: 'fas fa-exclamation-triangle',
                    title: 'Payment Follow-up',
                    message: `You have ${formatCurrency(pendingAmount)} in pending payments. Consider following up with buyers to improve cash flow.`
                });
            }
            
            const totalLivestock = livestock.reduce((sum, l) => sum + parseInt(l.quantity), 0);
            if (totalLivestock > 0) {
                recommendations.push({
                    type: 'info',
                    icon: 'fas fa-heart',
                    title: 'Livestock Health',
                    message: `Monitor your ${totalLivestock} livestock regularly. Regular health checks can prevent losses and improve productivity.`
                });
            }
            
            if (sales.length > 0) {
                const totalRevenue = sales.reduce((sum, s) => sum + s.total_amount, 0);
                recommendations.push({
                    type: 'success',
                    icon: 'fas fa-chart-line',
                    title: 'Sales Growth',
                    message: `You've made ${sales.length} sales totaling ${formatCurrency(totalRevenue)}. Consider expanding your buyer network to increase sales volume.`
                });
            }

            const container = document.getElementById('recommendations-container');
            
            if (recommendations.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">Add some data to get personalized recommendations!</p>';
                return;
            }

            container.innerHTML = recommendations.map(rec => `
                <div style="background: ${getRecommendationColor(rec.type)}; padding: 20px; border-radius: 10px; border-left: 4px solid ${getRecommendationBorderColor(rec.type)}; margin-bottom: 15px;">
                    <h4 style="color: ${getRecommendationTextColor(rec.type)}; margin-bottom: 10px;">
                        <i class="${rec.icon}"></i> ${rec.title}
                    </h4>
                    <p style="color: #666; margin-bottom: 0;">${rec.message}</p>
                </div>
            `).join('');
        }

        function getRecommendationColor(type) {
            switch(type) {
                case 'success': return '#d4edda';
                case 'warning': return '#fff3cd';
                case 'info': return '#cce5ff';
                default: return '#f8d7da';
            }
        }

        function getRecommendationBorderColor(type) {
            switch(type) {
                case 'success': return '#28a745';
                case 'warning': return '#ffc107';
                case 'info': return '#007bff';
                default: return '#dc3545';
            }
        }

        function getRecommendationTextColor(type) {
            switch(type) {
                case 'success': return '#155724';
                case 'warning': return '#856404';
                case 'info': return '#004085';
                default: return '#721c24';
            }
        }

        // Load reports on page load
        document.addEventListener('DOMContentLoaded', loadReports);
    </script>
</body>
</html>
